<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MandiSense Voice Translation Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { background: #f5f5f5; padding: 20px; margin: 20px 0; border-radius: 10px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .primary { background: #007bff; color: white; }
        .success-btn { background: #28a745; color: white; }
        .test-result { margin: 10px 0; padding: 10px; background: white; border-left: 4px solid #007bff; }
    </style>
</head>
<body>
    <h1>üé§ MandiSense Voice Translation Test</h1>
    
    <div class="status info" id="connectionStatus">
        Connecting to server...
    </div>
    
    <div class="test-section">
        <h2>üîß System Tests</h2>
        <button class="primary" onclick="testAPIEndpoints()">Test API Endpoints</button>
        <button class="primary" onclick="testWebSocketConnection()">Test WebSocket</button>
        <button class="success-btn" onclick="testVoiceTranslation()">Test Voice Translation</button>
        <div id="testResults"></div>
    </div>
    
    <div class="test-section">
        <h2>üó£Ô∏è Voice Translation Demo</h2>
        <p>Select languages and test the translation system:</p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <h3>Vendor (Seller)</h3>
                <select id="vendorLang">
                    <option value="hindi">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
                    <option value="tamil">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>
                    <option value="english">English</option>
                </select>
                <br><br>
                <button class="primary" onclick="simulateVendorSpeech()">üé§ Simulate Vendor Speech</button>
                <div id="vendorResult" class="test-result" style="display: none;"></div>
            </div>
            
            <div>
                <h3>Customer (Buyer)</h3>
                <select id="customerLang">
                    <option value="tamil">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>
                    <option value="hindi">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
                    <option value="english">English</option>
                </select>
                <br><br>
                <button class="primary" onclick="simulateCustomerSpeech()">üé§ Simulate Customer Speech</button>
                <div id="customerResult" class="test-result" style="display: none;"></div>
            </div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>üìä System Status</h2>
        <div id="systemStatus"></div>
        <button class="primary" onclick="refreshSystemStatus()">Refresh Status</button>
    </div>

    <script>
        const socket = io('http://localhost:8081');
        let currentSession = null;
        
        socket.on('connect', function() {
            updateConnectionStatus('Connected to MandiSense server', 'success');
        });
        
        socket.on('disconnect', function() {
            updateConnectionStatus('Disconnected from server', 'error');
        });
        
        socket.on('audio_session_created', function(data) {
            currentSession = data.session_id;
            addTestResult('Audio session created: ' + data.session_id, 'success');
        });
        
        socket.on('audio_translation_result', function(data) {
            const resultDiv = data.speaker === 'vendor' ? 'vendorResult' : 'customerResult';
            const result = document.getElementById(resultDiv);
            result.style.display = 'block';
            result.innerHTML = `
                <strong>Original (${data.original_language}):</strong> ${data.original_text}<br>
                <strong>Translated (${data.target_language}):</strong> ${data.translated_text}<br>
                <small>Confidence: ${(data.confidence * 100).toFixed(1)}% | Processing: ${(data.processing_time * 1000).toFixed(0)}ms</small>
            `;
        });
        
        function updateConnectionStatus(message, type) {
            const status = document.getElementById('connectionStatus');
            status.textContent = message;
            status.className = 'status ' + type;
        }
        
        function addTestResult(message, type) {
            const results = document.getElementById('testResults');
            const div = document.createElement('div');
            div.className = 'test-result';
            div.innerHTML = `<span class="${type}">${message}</span>`;
            results.appendChild(div);
        }
        
        async function testAPIEndpoints() {
            addTestResult('Testing API endpoints...', 'info');
            
            try {
                // Test negotiation endpoint
                const response = await fetch('http://localhost:8081/api/ultra_advanced_negotiation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        vendor_text: 'Fresh tomatoes, 30 rupees per kg',
                        buyer_text: 'Good quality, can you do 28 rupees?',
                        commodity: 'tomatoes',
                        context: { audio_enabled: true }
                    })
                });
                
                if (response.ok) {
                    addTestResult('‚úÖ Negotiation API working', 'success');
                } else {
                    addTestResult('‚ùå Negotiation API failed', 'error');
                }
                
                // Test audio analytics
                const audioResponse = await fetch('http://localhost:8081/api/audio_analytics');
                if (audioResponse.ok) {
                    const data = await audioResponse.json();
                    addTestResult(`‚úÖ Audio Analytics: ${data.supported_languages} languages supported`, 'success');
                } else {
                    addTestResult('‚ùå Audio Analytics failed', 'error');
                }
                
            } catch (error) {
                addTestResult('‚ùå API test failed: ' + error.message, 'error');
            }
        }
        
        function testWebSocketConnection() {
            addTestResult('Testing WebSocket connection...', 'info');
            
            if (socket.connected) {
                addTestResult('‚úÖ WebSocket connected successfully', 'success');
                
                // Create audio session
                socket.emit('create_audio_session', {
                    vendor_language: 'hindi',
                    customer_language: 'tamil'
                });
            } else {
                addTestResult('‚ùå WebSocket not connected', 'error');
            }
        }
        
        function testVoiceTranslation() {
            addTestResult('Testing voice translation system...', 'info');
            
            if (!currentSession) {
                socket.emit('create_audio_session', {
                    vendor_language: 'hindi',
                    customer_language: 'tamil'
                });
                setTimeout(() => testVoiceTranslation(), 1000);
                return;
            }
            
            // Simulate audio data
            const mockAudioData = btoa('mock_audio_data_for_testing');
            
            socket.emit('process_audio', {
                session_id: currentSession,
                speaker: 'vendor',
                audio_data: mockAudioData,
                language: 'hindi'
            });
            
            addTestResult('‚úÖ Voice translation test initiated', 'success');
        }
        
        function simulateVendorSpeech() {
            const lang = document.getElementById('vendorLang').value;
            const mockPhrases = {
                hindi: '‡§ü‡§Æ‡§æ‡§ü‡§∞ ‡§ï‡•Ä ‡§ï‡•Ä‡§Æ‡§§ 30 ‡§∞‡•Å‡§™‡§Ø‡•á ‡§™‡•ç‡§∞‡§§‡§ø ‡§ï‡§ø‡§≤‡•ã ‡§π‡•à',
                tamil: '‡Æ§‡Æï‡Øç‡Æï‡Ææ‡Æ≥‡Æø‡ÆØ‡Æø‡Æ©‡Øç ‡Æµ‡Æø‡Æ≤‡Øà ‡Æï‡Æø‡Æ≤‡Øã 30 ‡Æ∞‡ØÇ‡Æ™‡Ææ‡ÆØ‡Øç',
                english: 'Tomatoes are 30 rupees per kilogram'
            };
            
            if (!currentSession) {
                socket.emit('create_audio_session', {
                    vendor_language: lang,
                    customer_language: document.getElementById('customerLang').value
                });
                setTimeout(() => simulateVendorSpeech(), 1000);
                return;
            }
            
            // Simulate processing
            const result = document.getElementById('vendorResult');
            result.style.display = 'block';
            result.innerHTML = '<em>Processing speech...</em>';
            
            setTimeout(() => {
                socket.emit('process_audio', {
                    session_id: currentSession,
                    speaker: 'vendor',
                    audio_data: btoa('mock_vendor_audio'),
                    language: lang
                });
            }, 500);
        }
        
        function simulateCustomerSpeech() {
            const lang = document.getElementById('customerLang').value;
            const mockPhrases = {
                hindi: '‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ 28 ‡§∞‡•Å‡§™‡§Ø‡•á ‡§Æ‡•á‡§Ç ‡§¶‡•á ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç?',
                tamil: '28 ‡Æ∞‡ØÇ‡Æ™‡Ææ‡ÆØ‡Øç‡Æï‡Øç‡Æï‡ØÅ ‡Æï‡Øä‡Æü‡ØÅ‡Æï‡Øç‡Æï ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡ØÅ‡ÆÆ‡Ææ?',
                english: 'Can you give it for 28 rupees?'
            };
            
            if (!currentSession) {
                socket.emit('create_audio_session', {
                    vendor_language: document.getElementById('vendorLang').value,
                    customer_language: lang
                });
                setTimeout(() => simulateCustomerSpeech(), 1000);
                return;
            }
            
            // Simulate processing
            const result = document.getElementById('customerResult');
            result.style.display = 'block';
            result.innerHTML = '<em>Processing speech...</em>';
            
            setTimeout(() => {
                socket.emit('process_audio', {
                    session_id: currentSession,
                    speaker: 'customer',
                    audio_data: btoa('mock_customer_audio'),
                    language: lang
                });
            }, 500);
        }
        
        async function refreshSystemStatus() {
            try {
                const [audioResponse, performanceResponse] = await Promise.all([
                    fetch('http://localhost:8081/api/audio_analytics'),
                    fetch('http://localhost:8081/api/performance_metrics')
                ]);
                
                const audioData = await audioResponse.json();
                const performanceData = await performanceResponse.json();
                
                document.getElementById('systemStatus').innerHTML = `
                    <div class="test-result">
                        <strong>Audio System:</strong><br>
                        ‚Ä¢ Languages: ${audioData.supported_languages}<br>
                        ‚Ä¢ Active Sessions: ${audioData.active_sessions}<br>
                        ‚Ä¢ Translation Accuracy: ${audioData.translation_accuracy}%<br>
                        ‚Ä¢ Processing Time: ${audioData.avg_processing_time}ms
                    </div>
                    <div class="test-result">
                        <strong>Performance:</strong><br>
                        ‚Ä¢ Total Negotiations: ${performanceData.total_negotiations}<br>
                        ‚Ä¢ Audio Sessions: ${performanceData.total_audio_sessions}<br>
                        ‚Ä¢ Active Connections: ${performanceData.active_connections}<br>
                        ‚Ä¢ Uptime: ${(performanceData.system_uptime_hours || 0).toFixed(2)} hours
                    </div>
                `;
            } catch (error) {
                document.getElementById('systemStatus').innerHTML = 
                    '<div class="test-result error">Failed to load system status</div>';
            }
        }
        
        // Auto-refresh system status on load
        window.onload = function() {
            setTimeout(refreshSystemStatus, 2000);
        };
    </script>
</body>
</html>