<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MandiSense - Test Frontend</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">MandiSense Test Interface</h1>
        
        <!-- Status Display -->
        <div class="bg-blue-50 rounded-lg p-4 mb-6">
            <h2 class="text-lg font-semibold text-blue-800 mb-2">System Status</h2>
            <div id="status-display" class="text-sm text-blue-600">Loading...</div>
        </div>

        <!-- Negotiation Input -->
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Test Negotiation</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Commodity</label>
                    <select id="commodity" class="w-full p-2 border border-gray-300 rounded-md">
                        <option value="tomatoes">Tomatoes</option>
                        <option value="onions">Onions</option>
                        <option value="rice">Rice</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Vendor Message</label>
                    <input type="text" id="vendor-text" 
                           placeholder="Fresh tomatoes, 25 rupees per kg"
                           class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Buyer Message</label>
                    <input type="text" id="buyer-text" 
                           placeholder="Can you do 22 rupees?"
                           class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                
                <div class="flex gap-2">
                    <button onclick="testNegotiation()" 
                            class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                        Process Negotiation
                    </button>
                    <button onclick="generateSignal()" 
                            class="flex-1 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">
                        Generate Signal
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Display -->
        <div class="bg-yellow-50 rounded-lg p-4 mb-6">
            <h2 class="text-lg font-semibold text-yellow-800 mb-2">Market Alignment Signal</h2>
            <div id="signal-display" class="text-sm text-yellow-700">
                No signal generated yet. Try processing a negotiation above.
            </div>
        </div>

        <!-- Market Context -->
        <div class="bg-green-50 rounded-lg p-4">
            <h2 class="text-lg font-semibold text-green-800 mb-2">Market Context</h2>
            <div id="context-display" class="text-sm text-green-700">Loading market context...</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';

        // Load initial market context
        async function loadMarketContext() {
            try {
                const response = await fetch(`${API_BASE}/market_context`);
                const data = await response.json();
                
                document.getElementById('status-display').innerHTML = `
                    <strong>System Status:</strong> Active<br>
                    <strong>Market Coherence:</strong> ${data.market_coherence.toFixed(3)}<br>
                    <strong>Trust Density:</strong> ${data.trust_density.toFixed(3)}<br>
                    <strong>System Maturity:</strong> ${data.system_maturity}
                `;
                
                document.getElementById('context-display').innerHTML = `
                    <strong>Total Patterns:</strong> ${data.total_patterns}<br>
                    <strong>Pattern Stability:</strong> ${data.pattern_stability.toFixed(3)}<br>
                    <strong>Behavioral Diversity:</strong> ${data.behavioral_diversity.toFixed(3)}<br>
                    <strong>Memory Health:</strong> ${data.memory_health}
                `;
                
            } catch (error) {
                console.error('Error loading market context:', error);
                document.getElementById('status-display').textContent = 'Error: Cannot connect to backend';
                document.getElementById('context-display').textContent = 'Error loading market context';
            }
        }

        // Test negotiation processing
        async function testNegotiation() {
            const vendorText = document.getElementById('vendor-text').value || 'Fresh tomatoes, 25 rupees per kg';
            const buyerText = document.getElementById('buyer-text').value || 'Can you do 22 rupees?';
            const commodity = document.getElementById('commodity').value;

            try {
                const response = await fetch(`${API_BASE}/simulate_negotiation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        vendor_text: vendorText,
                        buyer_text: buyerText,
                        commodity: commodity
                    })
                });

                const data = await response.json();
                
                const vendorSignal = data.vendor.signal || '[System maintains silence]';
                const buyerSignal = data.buyer.signal || '[System maintains silence]';
                
                document.getElementById('signal-display').innerHTML = `
                    <strong>Vendor Signal:</strong> ${vendorSignal}<br>
                    <strong>Buyer Signal:</strong> ${buyerSignal}<br>
                    <strong>Market Coherence:</strong> ${data.market_context.coherence.toFixed(3)}
                `;

                // Refresh market context
                loadMarketContext();
                
            } catch (error) {
                console.error('Error processing negotiation:', error);
                document.getElementById('signal-display').textContent = 'Error processing negotiation';
            }
        }

        // Generate signal only
        async function generateSignal() {
            const vendorText = document.getElementById('vendor-text').value || 'Quality produce, 26 rupees per kg, fair price';
            const buyerText = document.getElementById('buyer-text').value || 'I trust your quality, 25 rupees works';
            const commodity = document.getElementById('commodity').value;

            document.getElementById('signal-display').textContent = 'Analyzing collective market patterns...';

            try {
                const response = await fetch(`${API_BASE}/generate_signal`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        vendor_text: vendorText,
                        buyer_text: buyerText,
                        commodity: commodity
                    })
                });

                const data = await response.json();
                
                document.getElementById('signal-display').innerHTML = `
                    <strong>Signal:</strong> ${data.signal}<br>
                    <strong>Confidence:</strong> ${(data.confidence * 100).toFixed(1)}%<br>
                    <strong>Pattern Familiarity:</strong> ${(data.pattern_familiarity * 100).toFixed(1)}%<br>
                    <strong>Market Coherence:</strong> ${data.market_coherence.toFixed(3)}
                `;

                // Refresh market context
                loadMarketContext();
                
            } catch (error) {
                console.error('Error generating signal:', error);
                document.getElementById('signal-display').textContent = 'Error generating signal';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadMarketContext();
        });
    </script>
</body>
</html>